<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>rplace.live Colour Utils</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<style>
		* {
			box-sizing: border-box;
		}
		
		body {
			font-family: Arial, sans-serif;
			background-color: #f6f7f8;
			color: #333;
			margin: 0;
			padding: 0;
			display: flex;
			flex-direction: column;
			align-items: center;
		}
		
		h1 {
			background-color: #ff4500;
			color: white;
			width: 100%;
			padding: 20px;
			margin: 0;
			text-align: center;
		}
		
		p {
			max-width: 800px;
			margin: 20px;
			font-size: 16px;
		}
		
		details {
			max-width: 800px;
			width: 100%;
			margin: 20px;
			padding: 20px;
			background-color: white;
			border: 1px solid #ddd;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			border-radius: 4px;
		}
		
		summary {
			margin-bottom: 10px;
			color: #0079d3;
		}
		
		summary:hover > .summary-title {
			text-decoration: underline;
		}
		
		.summary-title {
			font-size: 20px;
			font-weight: bold;
			cursor: pointer;
			margin-top: 0px;
			margin-bottom: 8px;
			display: inline-block;
		}
		
		.summary-description {
			color: #333;
			display: block;
			text-decoration: none;
		}
		
		summary::before {
			content: "Toggle";
			font-size: 14px;
			color: white;
			background-color: #0079d3;
			border: none;
			padding: 5px 10px;
			cursor: pointer;
			margin-top: -5px;
			float: right;
		}
		
		.section-content {
			display: flex;
			flex-direction: column;
			row-gap: 16px;
		}

		fieldset {
			margin: 0;
			border: 0;
			padding: 16px;
			background-color: #d3d3d32b;
			border-radius: 4px;
		}

		.code{
			font-family: monospace; font-weight: bold;
		}
	</style>
</head>
<body>
	<h1>rplace.live Colour Utils</h1>
	<p>This page contains a collection of simple convenience scripts for working with and modifying rplace canvas/palette data!</p>
	<details>
		<summary>
			<h4 class="summary-title">image2palette</h4>
			<strong class="summary-description">Extracts the colours from an image file into a palette of all present colours in the image.</strong>
		</summary>
		<div class="section-content">
			<label for="paletteFileInput">Image file:</label>
			<input type="file" id="paletteFileInput">
			<label for="paletteSimilarityRange">Colour similarity margin: <span>25%</span></label>
			<input type="range" id="paletteSimilarityRange" min="0" max="0.5" step="0.01">
			<button type="button" id="paletteDoneButton">Extract colour palette</button>
			<div id="imageResult" class="code"></div>
		</div>
	</details>
	<details>
		<summary>
			<h4 class="summary-title">canvas2image</h4>
			<strong class="summary-description">Converts an rplace.live canvas file into a normal .png image.</strong>
		</summary>
		<div class="section-content">
			<div>
				<label for="canvasUrlCheckbox">Fetch canvas & metadata from URL:</label>
				<input type="checkbox" id="canvasUrlCheckbox" checked>
			</div>
			<fieldset class="section-content" id="canvasUrlSection">
				<label for="canvasUrlInput">Canvas server URL (such as https://raw.githubusercontent.com/rplacetk/canvas1/main):</label>
				<input type="text" id="canvasUrlInput">
			</fieldset>
			<fieldset class="section-content" id="canvasInputsSection">
				<div class="section-content">
					<label for="canvasFileInput">Canvas file:</label>
					<input type="file" id="canvasFileInput">
				</div>
				<div>
					<label for="canvasMetadataCheckbox">Use raw JSON canvas metadata:</label>
					<input type="checkbox" id="canvasMetadataCheckbox">
				</div>
				<fieldset class="section-content" id="canvasMetadataSection">
					<label for="canvasMetadataInput">Enter raw JSON metadata (such as { width:number, height:number, palette:Array&lt;number&gt; }):</label>
					<input type="text" id="canvasMetadataInput">
				</fieldset>
				<fieldset class="section-content" id="canvasDetailsSection">
					<span>
						<label for="canvasWidthInput">Canvas width:</label>
						<input type="number" id="canvasWidthInput">
					</span>
					<span>
						<label for="canvasHeightInput">Canvas height:</label>
						<input type="number" id="canvasHeightInput">
					</span>
					<label for="canvasPaletteInput">Palette (comma-separated colors or JSON array):</label>
					<input type="text" id="canvasPaletteInput">
				</fieldset>	
			</fieldset>
			<button type="button" id="canvasDoneButton">Generate image</button>
			<img id="canvasResultImg">
			<a id="canvasResultLink" style="display: none;" download></a>
		</div>
	</details>
	<details>
		<summary>
			<h4 class="summary-title">image2canvas</h4>
			<strong class="summary-description">Converts a normal image file into a rplace.live canvas file.</strong>
		</summary>
		<div class="section-content">
			<label for="imagePaletteInput">Palette (list of hex or integer colours separated by commas OR a JSON array):</label>
			<input type="text" id="imagePaletteInput" class="code">
			<label for="imageCanvasFileInput">Image file:</label>
			<input type="file" id="imageCanvasFileInput">
			<span>
				<label for="canvasGenWidthInput">Width:</label>
				<input type="number" id="canvasGenWidthInput">
			</span>
			<span>
				<label for="canvasGenHeightInput">Height:</label>
				<input type="number" id="canvasGenHeightInput">
			</span>
			<button type="button" id="imageDoneButton">Generate canvas file</button>
		</div>
	</details>
	<details>
		<summary>
			<h4 class="summary-title">hex2int</h4>
			<strong class="summary-description">Converts a list of hexadecimal colours into a list of rplace.live-compatible integer colours.</strong>
		</summary>
		<div class="section-content">
			<label for="hexInput">Colours (list of hex or separated by commas OR a JSON array):</label>
			<input type="text" id="hexInput" class="code">
			<span>
				<input type="checkbox" id="bswap" checked>
				<label for="bswap">Rplace (0xRRGGBBAA) format</label>
			</span>
			<button type="button" id="hexDoneButton">Convert to integer colours</button>
			<div id="hexResult" class="code"></div>
		</div>
	</details>
	<details>
		<summary>
			<h4 class="summary-title">Lineafy</h4>
			<strong class="summary-description">Tints a list of colours to lie on a given gradient</strong>
		</summary>
		<div class="section-content">
			<label for="hexInput">Colour(s) (list of hex or separated by commas OR a JSON array):</label>
			<input type="text" id="lineafyInput" class="code">
			<span>
				R1=<input type="number" id="lineafyR1" class="code" value="0">
				G1=<input type="number" id="lineafyG1" class="code" value="0">
				B1=<input type="number" id="lineafyB1" class="code" value="0">
			</span>
			<span>
				R2=<input type="number" id="lineafyR2" class="code" value="1">
				G2=<input type="number" id="lineafyG2" class="code" value="0">
				B2=<input type="number" id="lineafyB2" class="code" value="0">
			</span>
			<button type="button" id="lineafyDoneButton">Lineafy!</button>
			<div id="lineafyResult" class="code"></div>
		</div>
	</details>
	<!--<details open>
		<summary>order-palette</summary>
		<div class="section-content">
			<strong>Organises a hexedecimal or integer palette into a chronological list of integer colours.</strong>
		</div>
	</details>-->
	<p>Â© Zekiah-A | rplace.live Colour Utils <a href="https://github.com/rplacetk/colour-utils">See Readme</a></p>
</body>
<script type="module">
	import { image2Palette, canvasFile2Image, imageFile2Canvas, boardToPng, stringToIntColor, intColorToString, bswap, download } from "./index.js"
	const $ = document.querySelector.bind(document)

	function listLikeToArray(input) {
		let array = []
		let jsonInput = null
		try{ jsonInput = JSON.parse(input) }catch{}

		array = Array.isArray(jsonInput) ? jsonInput : input.split(",")
		return array.map(value => typeof value === "string" ? value.trim() : value.toString())
	}
	
	const paletteSimilarityRange = $('#paletteSimilarityRange')
	const paletteSimilarityLabel = $('[for=paletteSimilarityRange] > span')
	let margin = 0.25
	paletteSimilarityRange.oninput = () => {
		margin = parseFloat(paletteSimilarityRange.value)
		paletteSimilarityLabel.textContent = (margin*100).toFixed(0) + '%'
	}

	$("#paletteDoneButton").addEventListener("click", async (event) => {
		const file = $("#paletteFileInput").files[0]
		if(!file) return

		const colors = await image2Palette(file, margin)
		console.log(colors)
		$('#imageResult').textContent = `(${colors.length}) ` + colors.join(', ')
	})

	function toggleSections(checkbox, section1, section2) {
		function updateSections() {
			const checked = checkbox.checked
			section1.style.display = checked ? "flex" : "none"
			section2.style.display = checked ? "none" : "flex"
		}
		checkbox.addEventListener("change", updateSections)
		updateSections()
	}
	toggleSections($("#canvasUrlCheckbox"), $("#canvasUrlSection"), $("#canvasInputsSection"))
	toggleSections($("#canvasMetadataCheckbox"), $("#canvasMetadataSection"), $("#canvasDetailsSection"))

	$("#canvasDoneButton").addEventListener("click", async (event) => {
		let imageBlob = null
		let imageName = null
		if ($("#canvasUrlCheckbox").checked) {
			const canvasUrl = $("#canvasUrlInput").value
			if (canvasUrl.endsWith("/")) {
				canvasUrl = canvasUrl.slice(0, canvasUrl.length - 1)
			}

			imageName = canvasUrl.slice(canvasUrl.lastIndexOf("/") + 1) + ".png"
			const placeRes = await fetch(canvasUrl + "/place")
			const board = await placeRes.arrayBuffer()
			const metadataRes = await fetch(canvasUrl + "/metadata.json")
			const metadata = await metadataRes.json()
			imageBlob = await boardToPng(board, metadata)
		}
		else {
			const file = $("#canvasFileInput").files[0]
			imageName = "place_" + file.name + ".png"
			let metadata = null

			if ($("#canvasMetadataCheckbox").checked) {
				metadata = $("#canvasMetadataInput").value
			}
			else {
				const width = $("#canvasWidthInput").value
				const height = $("#canvasHeightInput").value
				// Rplace colors 0xRRGGBBAA ðŸ¥€
				const palette = listLikeToArray($("#canvasPaletteInput").value).map(col => bswap(stringToIntColor(col))>>>0)
				metadata = { width, height, palette }
			}
			imageBlob = await canvasFile2Image(file, metadata)
		}
		const imageUrl = URL.createObjectURL(imageBlob)
		canvasResultImg.src = imageUrl
		canvasResultLink.style.display = "block"
		canvasResultLink.href = imageUrl
		canvasResultLink.textContent = "Download " + imageName
	})
	let imageToGen = null
	$('#imageCanvasFileInput').onchange = async function(){
		if(!this.files[0]){
			imageToGen = null
			return
		}
		imageToGen = await createImageBitmap(this.files[0])

		canvasGenWidthInput.value = imageToGen.width
		canvasGenHeightInput.value = imageToGen.height
	}
	const imagePaletteInput = $('#imagePaletteInput'), hexInput = $('#hexInput')
	$("#imageDoneButton").addEventListener("click", async (event) => {
		const intArray = listLikeToArray(imagePaletteInput.value).map(stringToIntColor)
		if(!imageToGen) return
		const width = canvasGenWidthInput.value>>>0, height = canvasGenHeightInput.value>>>0
		imageFile2Canvas(imageToGen, intArray, width, height)
			.then(arr => download(new Blob([arr], {type: '@file/octet-stream'}), 'place'))
	})
	
	$("#hexDoneButton").addEventListener("click", (event) => {
		// Rplace uses 0xRRGGBBAA ðŸ¥€
		const shouldBswap = $('#bswap').checked
		$('#hexResult').textContent = listLikeToArray(hexInput.value).map(col => shouldBswap ? bswap(stringToIntColor(col))>>>0 : stringToIntColor(col)>>>0).join(", ")
	})
	$('#lineafyDoneButton').addEventListener('click', () => {
		const intArray = listLikeToArray($('#lineafyInput').value).map(stringToIntColor)
		const r1 = $('#lineafyR1').value * 255 || 0
		const g1 = $('#lineafyG1').value * 255 || 0
		const b1 = $('#lineafyB1').value * 255 || 0
		const rd = ($('#lineafyR2').value - r1) || 0
		const gd = ($('#lineafyG2').value - g1) || 0
		const bd = ($('#lineafyB2').value - b1) || 0
		const coeff = 1/(rd*rd+gd*gd+bd*bd)
		const colors = []
		for(const col of intArray){
			let r = col&255, g = (col>>8)&255, b = (col>>16)&255, a = col>>>24
			r -= r1; g -= g1; b -= b1
			const fit = (r*rd+g*gd+b*bd)*coeff
			r = Math.max(0, Math.min(Math.round(fit*rd + r1), 255))
			g = Math.max(0, Math.min(Math.round(fit*gd + g1), 255))
			b = Math.max(0, Math.min(Math.round(fit*bd + b1), 255))
			colors.push(intColorToString(r|g<<8|b<<16|a<<24))
		}
		$('#lineafyResult').textContent = colors.join(', ')
	})
</script>
</html>
